# Generated by Django 3.2.18 on 2023-05-17 14:54

from django.db import migrations, models
import django.db.models.deletion


def remove_masterclass_teammember(apps, schema_editor):
    Event = apps.get_model("afisha", "Event")
    Event.objects.filter(type="MASTERCLASS").update(type="READING")

    MasterClass = apps.get_model("afisha", "MasterClass")
    Reading = apps.get_model("afisha", "Reading")

    for masterclass in MasterClass.objects.all():
        team_members = masterclass.team_members
        reading = Reading.objects.create(
            play = None,
            name = masterclass.name,
            description = masterclass.description,
            events = masterclass.events,
            main_image = masterclass.main_image,
            intro = masterclass.intro
        )
        for team_member in team_members:
            team_member.masterclass = None
            team_member.reading = reading





class Migration(migrations.Migration):

    dependencies = [
        ('library', '0039_auto_20221204_0125'),
    ]

    operations = [
        migrations.RunPython(remove_masterclass_teammember, migrations.RunPython.noop),
        migrations.RemoveConstraint(
            model_name='teammember',
            name='unique_person_role_per_masterclass',
        ),
        migrations.RemoveConstraint(
            model_name='teammember',
            name='library_teammember_only_one_of_reading_masterclass_performance',
        ),
        migrations.RemoveField(
            model_name='teammember',
            name='masterclass',
        ),
        migrations.AddConstraint(
            model_name='teammember',
            constraint=models.CheckConstraint(check=models.Q(models.Q(('performance__isnull', False), ('reading__isnull', True)), models.Q(('performance__isnull', True), ('reading__isnull', False)), _connector='OR'), name='library_teammember_only_one_of_reading_performance'),
        ),
    ]
